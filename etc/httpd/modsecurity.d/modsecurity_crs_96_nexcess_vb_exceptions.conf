# Vbulletin ModSecurity Exceptions.
# Currently tested on vBulletin 5.1.0

# VB5
# Various requests in vBulletin send a variable containing a string that would match:
# '\wstyle\w'
# Which triggers rule 973338. For example:
# - Downloading a Style from the Style Manager (/admincp/template.php)
# - Replying to a thread (/create-content/loadnode)
# - Loading the page manager (/css.php)
# - Loading any page while the "Edit Site" button is enabled. (/ajax/api/phrase/fetch)
SecRule REQUEST_METHOD "^(?:POST|GET)$" "chain,t:none,pass,nolog,id:'4096000'"
    SecRule REQUEST_URI "/admincp/|/css.php|/ajax/api/phrase/fetch|/create-content/load(?:node|-preview)" "ctl:ruleRemoveById=973338"

# VB5
# Saving changes in Page Manager
SecRule REQUEST_METHOD "^POST$" "chain,t:none,pass,nolog,id:'4096001'"
    SecRule REQUEST_URI "/ajax/api/widget/saveForums" " \
    ctl:ruleRemoveTargetById=981242, \
    ctl:ruleRemoveTargetById=981243, \
    ctl:ruleRemoveTargetById=981245, \
    ctl:ruleRemoveTargetById=981246, \
    ctl:ruleRemoveTargetById=981257"

# VB5 & VB3
# admincp Login
# lots of JSON in postvars
SecRule REQUEST_METHOD "^POST$" "chain,t:none,pass,nolog,id:'4096002'"
    SecRule REQUEST_URI "/login.php" " \
    ctl:ruleRemoveTargetById=973335;ARGS:postvars, \
    ctl:ruleRemoveTargetById=973338;ARGS:postvars, \
    ctl:ruleRemoveTargetById=973347;ARGS:postvars, \
    ctl:ruleRemoveTargetById=981231;ARGS:postvars, \
    ctl:ruleRemoveTargetById=981240;ARGS:postvars, \
    ctl:ruleRemoveTargetById=981242;ARGS:postvars, \
    ctl:ruleRemoveTargetById=981243;ARGS:postvars, \
    ctl:ruleRemoveTargetById=981245;ARGS:postvars, \
    ctl:ruleRemoveTargetById=981246;ARGS:postvars, \
    ctl:ruleRemoveTargetById=981255;ARGS:postvars, \
    ctl:ruleRemoveTargetById=981257;ARGS:postvars"

# VB5
# HTML badness when:
# - replying to or creating new thread (ARGS:text)
# - sending a private message (ARGS:text, ARGS:pagetext)
# - creating an article (ARGS:text, ARGS:description)
# - editing an article (for some reason uses /create-content/Text/ instead of /create-content/text/)
SecRule REQUEST_METHOD "^POST$" "chain,t:none,pass,nolog,id:'4096003'"
    SecRule REQUEST_URI "/create-content/(?:[tT]ext|private-message)/|/ajax/api/editor/autosave" " \
    ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/;ARGS:text, \
    ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/;ARGS:pagetext, \
    ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/;ARGS:description, \
    ctl:ruleRemoveTargetByTag=OWASP_CRS/PROTOCOL_VIOLATION/;ARGS:text \
    ctl:ruleRemoveTargetByTag=OWASP_CRS/PROTOCOL_VIOLATION/;ARGS:pagetext, \
    ctl:ruleRemoveTargetByTag=OWASP_CRS/PROTOCOL_VIOLATION/;ARGS:description"

# VB5
# Preview article edit
SecRule REQUEST_METHOD "^POST$" "chain,t:none,pass,nolog,id:'4096004'"
    SecRule REQUEST_URI "/create-content/load-preview" " \
    ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/;ARGS:rawtext, \
    ctl:ruleRemoveTargetById=973338;ARGS=ARGS:pagedata[ckeditorCss], \
    ctl:ruleRemoveTargetByTag=OWASP_CRS/PROTOCOL_VIOLATION/;ARGS:rawtext, \
    ctl:ruleRemoveTargetById=973338;ARGS:pagedata[ckeditorCss]"

# VB5
# Post article comment
SecRule REQUEST_METHOD "^POST$" "chain,t:none,pass,nolog,id:'4096005'"
    SecRule REQUEST_URI "/ajax/post-comment" " \
    ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/;ARGS:text, \
    ctl:ruleRemoveTargetByTag=OWASP_CRS/PROTOCOL_VIOLATION/;ARGS:text"

# VB5
# HTML in "Reason For Turning Site Off" box
SecRule REQUEST_METHOD "^POST$" "chain,t:none,pass,nolog,id:'4096006'"
    SecRule REQUEST_URI "/admincp/options.php" " \
    ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/XSS;ARGS:setting[bbclosedreason], \
    ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/SQL_INJECTION;ARGS:setting[bbclosedreason]"

# VB5
# Downloading style
# admincp --> Styles & Templates --> Download / Upload Style Manager
SecRule REQUEST_METHOD "^POST$" "chain,t:none,pass,nolog,id:'4096007'"
    SecRule REQUEST_URI "/admincp/template.php" "ctl:ruleRemoveTargetById=973338;ARGS:filename"

# VB5
# Saving settings in Language Manager
# admincp --> Language & Phrases --> Language Manager
SecRule REQUEST_METHOD "^POST$" "chain,t:none,pass,nolog,id:'4096008'"
    SecRule REQUEST_URI "/admincp/language.php" " \
    ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/XSS;ARGS:phr[notice_1_html], \
    ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/XSS;ARGS:def[notice_1_html], \
    ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/SQL_INJECTION;ARGS:phr[notice_1_html], \
    ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/SQL_INJECTION;ARGS:def[notice_1_html]"

# VB5
# Changing or adding new notice
# admincp --> Notices --> Notice Manager
SecRule REQUEST_METHOD "^POST$" "chain,t:none,pass,nolog,id:'4096009'"
    SecRule REQUEST_URI "/admincp/notice.php" " \
    ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/XSS;ARGS:html, \
    ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/SQL_INJECTION;ARGS:html"

# VB5
# Adding annouments
# admincp --> Announcements --> Announcement Manager
SecRule REQUEST_METHOD "^POST$" "chain,t:none,pass,nolog,id:'4096010'"
    SecRule REQUEST_URI "/admincp/announcement.php" "\
    ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/XSS;ARGS:pagetext, \
    ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/SQL_INJECTION;ARGS:pagetext"

# VB5
# Add new user user title and signature can contain html
# admincp --> Users --> Add New User
SecRule REQUEST_METHOD "^POST$" "chain,t:none,pass,nolog,id:'4096011'"
    SecRule REQUEST_URI "/admincp/user.php" " \
    ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/XSS;ARGS:user[usertitle], \
    ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/XSS;ARGS:user[signature], \
    ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/SQL_INJECTION;ARGS:user[usertitle], \
    ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/SQL_INJECTION;ARGS:user[signature]"

# VB5
# Send email to users
# admincp --> Users --> Send Email to Users
SecRule REQUEST_METHOD "^POST$" "chain,t:none,pass,nolog,id:'4096012'"
    SecRule REQUEST_URI "/admincp/email.php" " \
    ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/XSS;ARGS:message, \
    ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/XSS;ARGS:serializeduser, \
    ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/SQL_INJECTION;ARGS:message, \
    ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/SQL_INJECTION;ARGS:serializeduser"

# VB5
# Problematic webserver module check. Trips URL encoding rules
SecRule REQUEST_METHOD "^GET$" "chain,t:none,pass,nolog,id:'4096013'"
    SecRule REQUEST_URI "(?:/core)?/admincp/clear.gif" " \
    ctl:ruleRemoveTargetById=950107, \
    ctl:ruleRemoveTargetById=950109;ARGS:test"

# VB4
# admincp --> Settings --> Options --> Forum Runner Settings --> Google AdSense Mobile Javascript
SecRule REQUEST_METHOD "^POST$" "chain,t:none,pass,nolog,id:'4096014'"
    SecRule REQUEST_URI "/admincp/options.php" " \
    ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/XSS;ARGS:setting[forumrunner_googleads_javascript], \
    ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/SQL_INJECTION;ARGS:setting[forumrunner_googleads_javascript]"

# VB4
# admincp --> vBulletin CMS --> Content Manager --> Delete Article
SecRule REQUEST_METHOD "^POST" "chain,t:none,pass,nolog,id:'4096015'"
    SecRule REQUEST_URI "/admincp/cms_content_admin.php" " \
    ctl:ruleRemoveTargetById=981319;ARGS:sectionid"

# VB4
# admincp --> Advertising --> Add New Ad --> Edit Ad HTML box
SecRule REQUEST_METHOD "^POST$" "chain,t:none,pass,nolog,id:'4096016'"
    SecRule REQUEST_URI "/admincp/ad.php" " \
    ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/XSS;ARGS:ad_html, \
    ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/SQL_INJECTION;ARGS:ad_html"

# VB4 
# admincp --> Styles & Templates --> Style Generator
# ARGS:data contains JSON
SecRule REQUEST_METHOD "^POST$" "chain,t:none,pass,nolog,id:'4096017'"
    SecRule REQUEST_URI "/admincp/template.php" " \
    ctl:ruleRemoveTargetById=981242;ARGS:data, \
    ctl:ruleRemoveTargetById=981243;ARGS:data, \
    ctl:ruleRemoveTargetById=981245;ARGS:data, \
    ctl:ruleRemoveTargetById=981246;ARGS:data, \
    ctl:ruleRemoveTargetById=981257;ARGS:data"

# VB4
# admincp --> Styles & Templates --> Style Manager --> All Style Options
SecRule REQUEST_METHOD "^POST$" "chain,t:none,pass,nolog,id:'4096018'"
    SecRule REQUEST_URI "/admincp/css.php" " \
    ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/XSS;ARGS:commontemplate[headinclude], \
    ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/XSS;ARGS:commontemplate[header], \
    ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/XSS;ARGS:commontemplate[footer], \
    ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/SQL_INJECTION;ARGS:commontemplate[headinclude], \
    ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/SQL_INJECTION;ARGS:commontemplate[header], \
    ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/SQL_INJECTION;ARGS:commontemplate[footer], \
    ctl:ruleRemoveTargetById=950911;ARGS:commontemplate[headinclude], \
    ctl:ruleRemoveById=981317"


# VB4
# admincp --> Styles & Templates --> Style Manager --> Style Variable Editor --> Global --> HTML Document Type (/admincp/stylevar.php)
# VB3
# admincp --> Styles & Templates --> Style Manager --> StyleVars (css.php)
SecRule REQUEST_METHOD "^POST$" "chain,t:none,pass,nolog,id:'4096019'"
    SecRule REQUEST_URI "/admincp/stylevar.php|/css.php" " \
    ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/XSS;ARGS:stylevar[htmldoctype], \
    ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/SQL_INJECTION;ARGS:stylevar[htmldoctype]"

# VB4
# admincp --> Styles & Templates --> Style Manager --> Add New Template
SecRule REQUEST_METHOD "^POST$" "chain,t:none,pass,nolog,id:'4096020'"
    SecRule REQUEST_URI "/admincp/template.php" " \
    ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/XSS;ARGS:template, \
    ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/SQL_INJECTION;ARGS:template"

# VB4
# admincp --> Threads & Posts --> Move --> Move Threads -- > Move All Threads
# contains JSON data
SecRule REQUEST_METHOD "^POST$" "chain,t:none,pass,nolog,id:'4096021'"
    SecRule REQUEST_URI "/admincp/thread.php" " \
    ctl:ruleRemoveTargetById=981242;ARGS:criteria, \
    ctl:ruleRemoveTargetById=981243;ARGS:criteria, \
    ctl:ruleRemoveTargetById=981245;ARGS:criteria, \
    ctl:ruleRemoveTargetById=981246;ARGS:criteria, \
    ctl:ruleRemoveTargetById=981257;ARGS:criteria"

# VB4
# admincp --> Usergroups --> Add New Usergroup --> Username HTML Markup
SecRule REQUEST_METHOD "^POST$" "chain,t:none,pass,nolog,id:'4096022'"
    SecRule REQUEST_URI "/admincp/usergroup.php" " \
    ctl:ruleRemoveTargetById=973300;ARGS:usergroup[opentag], \
    ctl:ruleRemoveTargetById=973300;ARGS:usergroup[closetag], \
    ctl:ruleRemoveTargetById=973306;ARGS:usergroup[opentag], \
    ctl:ruleRemoveTargetById=973306;ARGS:usergroup[closetag]"

# VB4 
# admincp --> Email Tools --> Upload List
# Request body contains raw SQL statement...
SecRule REQUEST_METHOD "^POST$" "chain,t:none,pass,nolog,id:'4096023'"
    SecRule REQUEST_URI "/admincp/verticalresponse.php" " \
    ctl:ruleRemoveTargetById=950109;ARGS:condition, \
    ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/SQL_INJECTION;ARGS:condition, \
    ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/XSS;ARGS:condition"

# VB4
# admincp --> Custom BB Codes --> Add New BB Code
# admincp --> Custom BB Codes --> BB Code Manager --> Test your BB Code
SecRule REQUEST_METHOD "^POST$" "chain,t:none,pass,nolog,id:'4096024'"
    SecRule REQUEST_URI "/admincp/bbcode.php" " \
    ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/XSS;ARGS:text, \
    ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/XSS;ARGS:bbcodereplacement, \
    ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/SQL_INJECTION;ARGS:text, \
    ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/SQL_INJECTION;ARGS:bbcodereplacement"

## VB4 things left to TEST:
# VB4
# Register new account
SecRule REQUEST_METHOD "^POST$" "chain,t:none,pass,nolog,id:'4096025'"
    SecRule REQUEST_URI "/register.php" "ctl:ruleRemoveById=973338;ARGS:recaptcha_challenge_field"

# VB4
# User Profile --> Send private message & send email (/private.php & /sendmessage.php
# Blog --> Create New Post (/blog_post.php)
# Article Editor (ajax.php & content.php)
# Edit Signature (/profile.php)
# Comment on Article & Edit Comment
# Frontend --> Calendar --> Add Event (calendar.php(
# Frontend --> Blogs --> Blog Settings --> Blog Description (/blog_usercp.php)
SecRule REQUEST_METHOD "^POST$" "chain,t:none,pass,nolog,id:'4096026'"
    SecRule REQUEST_URI "/(?:private|sendmessage|blog_post|ajax|content|profile|newreply|editpost|calendar|blog_usercp)\.php" " \
    ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/XSS;ARGS:message, \
    ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/XSS;ARGS:message_backup, \
    ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/SQL_INJECTION;ARGS:message_backup, \
    ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/SQL_INJECTION;ARGS:message"

# VB4
# Some places that allow raw PHP to be submitted.
# admincp --> Plugins and Products --> Plugin Manager --> Edit
SecRule REQUEST_METHOD "^POST$" "chain,t:none,pass,nolog,id:'4096027'"
    SecRule REQUEST_URI "/admincp/plugin.php" " \
    ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/;ARGS:phpcode"

# VB4
# Frontend --> Articles --> Create PHP Direct Evaluation
SecRule REQUEST_METHOD "^POST$" "chain,t:none,pass,nolog,id:'4096028'"
    SecRule REQUEST_URI "/content.php" " \
    ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/;ARGS:pagetext, \
    ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/;ARGS:previewtext"

#VB3 stuff tested so far:
# Frontend:
# - most thingys
# Backend:
#


# VB3
# Create thread (/newthread.php)
# Post visitor message (/visitormessage.php)
# Post group discussion (/group.php)
SecRule REQUEST_METHOD "^POST$" "chain,t:none,pass,nolog,id:'4096029'"
    SecRule REQUEST_URI "/(?:newthread|visitormessage|group)\.php" " \
    ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/XSS;ARGS:message, \
    ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/SQL_INJECTION;ARGS:message"

# VB3
# Delete thread. postvars variables contains JSON
SecRule REQUEST_METHOD "^POST$" "chain,t:none,pass,nolog,id:'4096030'"
    SecRule REQUEST_URI "/login.php" " \
    ctl:ruleRemoveTargetById=981242;ARGS:postvars, \
    ctl:ruleRemoveTargetById=981243;ARGS:postvars, \
    ctl:ruleRemoveTargetById=981245;ARGS:postvars, \
    ctl:ruleRemoveTargetById=981246;ARGS:postvars, \
    ctl:ruleRemoveTargetById=981257;ARGS:postvars, \
    ctl:ruleRemoveTargetById=973333;ARGS:postvars"

# VB3
# admincp --> Styles & Templates --> Style Manager --> Main CSS
# Too many request body parameters to whitelist here.
SecRule REQUEST_METHOD "^POST$" "chain,t:none,pass,nolog,id:'4096031'"
    SecRule REQUEST_URI "/admincp/css.php" " \
    ctl:ruleRemoveByTag=OWASP_CRS/WEB_ATTACK/XSS, \
    ctl:ruleRemoveByTag=OWASP_CRS/WEB_ATTACK/SQL_INJECTION"

# VB3
# admincp --> User Ranks --> Rank Type
SecRule REQUEST_METHOD "^POST$" "chain,t:none,pass,nolog,id:'4096032'"
    SecRule REQUEST_URI "/admincp/ranks.php" " \
    ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/XSS;ARGS:rankhtml, \
    ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/SQL_INJECTION;ARGS:rankhtml"

# VB3
# admincp --> Admin Notes
SecRule REQUEST_METHOD "^POST$" "chain,t:none,pass,nolog,id:'4096033'"
    SecRule REQUEST_URI "/admincp/index.php" " \
    ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/XSS;ARGS:notes, \
    ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/SQL_INJECTION;ARGS:notes"


