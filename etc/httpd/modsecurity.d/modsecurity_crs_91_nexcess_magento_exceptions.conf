# Admin URL Fields that allow html input.
<LocationMatch /(checkout_agreement|cms_(page|block)(_revision|_version)?|widget_instance|catalog_(product|product_set|product_attribute|product_action_attribute|category)|newsletter_(template|queue|subscriber|problem)|mobile|system_email_template|system_convert_gui|system_config)/>
    SecRuleRemoveById 950018 # UPDF XSS
    SecRuleRemoveById 960024 # Consecutive non-word characters
	SecRuleRemoveById 950109 # Multiple URL encodings
	SecRuleRemoveById 950911 # HTTP response splitting
	SecRuleRemoveById 960915 # Unmatched Boundary
	SecRuleRemoveByTag 'OWASP_CRS/WEB_ATTACK/SQL_INJECTION'
	SecRuleRemoveByTag 'OWASP_CRS/WEB_ATTACK/XSS'
</LocationMatch>

# Saving in System --> Configuration Area
<LocationMatch /index.php/[A-Za-z0-9_-]{1,100}/system_config>
	SecRuleRemoveById 981319 # when saving in design section (SQL operators)
	SecRuleRemoveById 950120 # Saving shipping method (RFI). 
</LocationMatch>

# Installing Extensions via Magento Connect
<LocationMatch /downloader/>
	SecRuleRemoveById 950120
</LocationMatch>

# Dashboard Graphs
<LocationMatch /index.php/[A-Za-z0-9_-]{1,100}/dashboard/tunnel>
	SecRuleRemoveById 950109
	SecRuleRemoveById 973337
</LocationMatch>

# Magentop API
<LocationMatch /index.php/api/(xmlrpc|soap)|/api/v2_soap|/api.php>
	SecRuleRemoveByTag 'OWASP_CRS/WEB_ATTACK/SQL_INJECTION'
	SecRuleRemoveByTag 'OWASP_CRS/WEB_ATTACK/XSS'
</LocationMatch>

# Checkout
<LocationMatch /(checkout|one(step|page)checkout)>
	SecRuleRemoveByTag 'OWASP_CRS/WEB_ATTACK/SQL_INJECTION'
	SecRuleRemoveByTag 'OWASP_CRS/WEB_ATTACK/XSS'
</LocationMatch>

# Contact Page, Product Reviews
<LocationMatch /contacts/|/review/product/post/id>
	SecRuleRemoveByTag 'OWASP_CRS/WEB_ATTACK/SQL_INJECTION'
	SecRuleRemoveByTag 'OWASP_CRS/WEB_ATTACK/XSS'
</LocationMatch>

# More specific whitelist for MULTIPART_UNMATCHED_BOUNDARY error
<LocationMatch /catalog_product_gallery/upload/key/>
        SecRuleUpdateActionById 960915 "setvar:tx.anomaly_score=-1"
</LocationMatch>

# Magemail extension sends raw SQL in older versions of it's API
SecRule REQUEST_METHOD "^POST$" \
    "phase:1,\
    id:'4091000',\
    nolog,\
    pass,\
    chain"
        SecRule REQUEST_URI "/magemail/api/(?:query|insert)/route/" \
            "ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/XSS;ARGS:query,\
            ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/SQL_INJECTION;ARGS:query,\
            ctl:ruleRemoveTargetById=981300-981317;ARGS:query"

# Promotions --> Catalog/Shopping Cart Price Rules --> Add New / Edit Rules --> Conditions --> Select Condition From Dropdown
SecRule REQUEST_METHOD "^POST$" \
    "phase:1,\
    id:4091001,\
    t:none,\
    pass,\
    nolog,\
    chain"
        SecRule REQUEST_URI "/promo_(?:catalog|quote)/" \
            "ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/SQL_INJECTION;ARGS,\
            ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/XSS;ARGS,\
            ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/SQL_INJECTION;ARGS_NAMES,\
            ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/XSS;ARGS_NAMES"

# aheadWorks Blog extension
# Blog --> Add Post
# Blog --> Categories 
SecRule REQUEST_METHOD "^POST$" \
    "phase:1,\
    id:4091002,\
    t:none,\
    pass,\
    nolog,\
    chain"
        SecRule REQUEST_URI "/blog_admin/(?:manage_blog|manage_cat)/" \
            "ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/SQL_INJECTION;ARGS:meta_description,\
            ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/XSS;ARGS:meta_description,\
            ctl:ruleRemoveTargetById=981300-981317;ARGS:meta_description,\
            ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/SQL_INJECTION;ARGS:meta_keywords,\
            ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/XSS;ARGS:meta_keywords,\
            ctl:ruleRemoveTargetById=981300-981317;ARGS:meta_keywords,\
            ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/SQL_INJECTION;ARGS:post_content,\
            ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/XSS;ARGS:post_content,\
            ctl:ruleRemoveTargetById=981300-981317;ARGS:post_content,\
            ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/SQL_INJECTION;ARGS:short_content,\
            ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/XSS;ARGS:short_content,\
            ctl:ruleRemoveTargetById=981300-981317;ARGS:short_content"

# PHP MySQL Bridge is integrated with eMagicOne's Magento Store Manager
SecRule REQUEST_METHOD "^POST$" \
    "phase:1,\
    id:4091003,\
    t:none,\
    pass,\
    nolog,\
    chain"
        SecRule ARGS:task "put_sql" \
            "ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/SQL_INJECTION;ARGS:sql,\
            ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/XSS;ARGS:sql,\
            ctl:ruleRemoveTargetById=981300-981317;ARGS:sql"

# Magento Popup extension
# CMS --> Popup --> Add/Edit Popup Item
SecRule REQUEST_METHOD "^POST$" \
    "phase:1,\
    id:4091004,\
    t:none,\
    pass,\
    nolog,\
    chain"
        SecRule REQUEST_URI "/popup/save/(?:id|key)/" \
            "ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/SQL_INJECTION;ARGS:popup_content,\
            ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/XSS;ARGS:popup_content,\
            ctl:ruleRemoveTargetById=981300-981317;ARGS:popup_content,\
            ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/SQL_INJECTION;ARGS:custom_css,\
            ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/XSS;ARGS:custom_css,\
            ctl:ruleRemoveTargetById=981300-981317;ARGS:custom_css"


# M2ePro extension
SecRule REQUEST_METHOD "^POST$" \
    "phase:1,\
    id:4091005,\
    t:none,\
    pass,\
    nolog,\
    chain"
        SecRule REQUEST_URI "/M2ePro/" \
            "ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/XSS;ARGS:data,\
            ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/XSS;ARGS:description[description_template],\
            ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/XSS;ARGS:selected_categories,\
            ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/XSS;ARGS:selected_path,\
            ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/XSS;ARGS:specific_data,\
            ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/XSS;ARGS:template_category_data,\
            ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/SQL_INJECTION;ARGS:attrSetId,\
            ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/SQL_INJECTION;ARGS:category_data,\
            ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/SQL_INJECTION;ARGS:category[identifiers],\
            ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/SQL_INJECTION;ARGS:category[path],\
            ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/SQL_INJECTION;ARGS:data,\
            ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/SQL_INJECTION;ARGS:data_value,\
            ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/SQL_INJECTION;ARGS:description,\
            ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/SQL_INJECTION;ARGS:description[condition_note_template],\
            ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/SQL_INJECTION;ARGS:description[description_template],\
            ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/SQL_INJECTION;ARGS:description[title_template],\
            ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/SQL_INJECTION;ARGS:options_data,\
            ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/SQL_INJECTION;ARGS:return[description],\
            ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/SQL_INJECTION;ARGS:selected_categories,\
            ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/SQL_INJECTION;ARGS:selected_path,\
            ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/SQL_INJECTION;ARGS:selectedProducts,\
            ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/SQL_INJECTION;ARGS:shipping[excluded_locations],\
            ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/SQL_INJECTION;ARGS:specific_data,\
            ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/SQL_INJECTION;ARGS:template_category_data,\
            ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/SQL_INJECTION;ARGS:title,\
            ctl:ruleRemoveById=981319,\
            ctl:ruleRemoveById=950001,\
            ctl:ruleRemoveById=959073,\
            ctl:ruleRemoveById=981242,\
            ctl:ruleRemoveById=981245,\
            ctl:ruleRemoveById=981317"

# Aleyant_Edoc extension
SecRule REQUEST_METHOD "^POST$" \
    "phase:1,\
    id:4091006,\
    t:none,\
    pass,\
    nolog,\
    chain"
        SecRule REQUEST_URI "/edoc/index/" \
            "ctl:ruleRemoveById=950000"

# Google Shopping Extension
SecRule REQUEST_METHOD "^POST$" \
    "phase:1,\
    id:4091007,\
    t:none,\
    pass,\
    nolog,\
    chain"
        SecRule REQUEST_URI "/simplegoogleshopping/adminhtml_simplegoogleshopping/" \
            "ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/SQL_Injection;ARGS:simplegoogleshopping_xmlitempattern,\
            ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/SQL_Injection;ARGS:simplegoogleshopping_xmlitempattern,\
            ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/XSS;ARGS:simplegoogleshopping_categories,\
            ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/XSS;ARGS:simplegoogleshopping_categories,\
            ctl:ruleRemoveTargetById=973300;ARGS:cause,\
            ctl:ruleRemoveTargetById=950001;ARGS:data,\
            ctl:ruleRemoveTargetById=950901;ARGS:data,\
            ctl:ruleRemoveTargetById=959073;ARGS:data,\
            ctl:ruleRemoveTargetById=981240;ARGS:data,\
            ctl:ruleRemoveTargetById=981255;ARGS:data"

# XTENTO sends xml in "xsl_template" request body parameter that trips ModSecurity:
# see tickets: VNCV-3421, MTYS-3783
SecRule REQUEST_METHOD "^POST$" \
    "phase:1,\
    id:4091008,\
    t:none,\
    pass,\
    nolog,\
    chain"
        SecRule REQUEST_URI "/(?:order|product)export_profile/(?:duplicate|edit|index|save|validateXslTemplate)/" \
            "ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/SQL_INJECTION;ARGS:xsl_template,\
            ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/XSS;ARGS:xsl_template,\
            ctl:ruleRemoveTargetById=950103;REQUEST_BODY,\
            ctl:ruleRemoveById=981317"


# XTENTO sets below cookie that trips modsec:
# lastMessage=Export of 17 orders completed successfully in 0 seconds. Click <a href="http://emilie.universalnyc.com/index.php/sfadmin/orderexport_log/download/id/2/key/5692225d32bd92926b3b90abb1abca9a/">here</a> to download exported files.
# see tickets: VNCV-3421, MTYS-3783
SecRule &REQUEST_COOKIES_NAMES:lastMessage "!@eq 0" \
    "phase:1,\
    id:4091009,\
    t:none,\
    pass,\
    nolog,\
    chain"
        SecRule REQUEST_COOKIES:lastMessage "Click <a href=" \
            "t:none,\
             t:urlDecode,\
             ctl:ruleRemoveTargetById=950901;REQUEST_COOKIES"

# Whitelist for magebird_popup extension. See ticket UCIH-7563
SecRule REQUEST_METHOD "^POST$" \
    "phase:1,\
    id:4091010,\
    t:none,\
    pass,\
    nolog,\
    chain"
        SecRule REQUEST_URI "/magebird_popup/save/" \
            "t:none,\
            ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/XSS;ARGS:content,\
            ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/XSS;ARGS:popup_content,\
            ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/XSS;ARGS:custom_css,\
            ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/SQL_INJECTION;ARGS:content,\
            ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/SQL_INJECTION;ARGS:popup_content,\
            ctl:ruleRemoveTargetByTag=OWASP_CRS/WEB_ATTACK/SQL_INJECTION;ARGS:custom_css"
